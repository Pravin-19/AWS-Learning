# Step 1: Detach all VPCs from Internet Gateways (IGWs) in all regions
echo "Detaching VPCs from Internet Gateways..."
regions=$(aws ec2 describe-regions --query "Regions[].RegionName" --output text)
for region in $regions; do
    igw_attachments=$(aws ec2 describe-internet-gateways --region $region --query "InternetGateways[].Attachments[?VpcId!='null'].VpcId" --output text)
    for vpc_id in $igw_attachments; do
        igw_id=$(aws ec2 describe-internet-gateways --region $region --filter Name=attachment.vpc-id,Values=$vpc_id --query "InternetGateways[0].InternetGatewayId" --output text)
        echo "Detaching VPC $vpc_id from Internet Gateway $igw_id in region $region..."
        aws ec2 detach-internet-gateway --region $region --internet-gateway-id $igw_id --vpc-id $vpc_id
    done
done

# Step 2: Delete all Internet Gateways (IGWs) in all regions
echo "Deleting Internet Gateways..."
for region in $regions; do
    igw_ids=$(aws ec2 describe-internet-gateways --region $region --query "InternetGateways[].InternetGatewayId" --output text)
    for igw_id in $igw_ids; do
        echo "Deleting Internet Gateway $igw_id in region $region..."
        aws ec2 delete-internet-gateway --region $region --internet-gateway-id $igw_id
    done
done

# Step 3: Delete all VPCs in all regions
echo "Deleting VPCs..."
for region in $regions; do
    vpc_ids=$(aws ec2 describe-vpcs --region $region --query "Vpcs[].VpcId" --output text)
    for vpc_id in $vpc_ids; do
        echo "Deleting VPC $vpc_id in region $region..."
        aws ec2 delete-vpc --region $region --vpc-id $vpc_id
    done
done

echo "Process completed."
